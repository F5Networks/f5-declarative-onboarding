# DO Release Process

## Release Artifacts
* Each DO release has several artifacts:
  * RPM
  * RPM sha256 checksum
  * Postman collection of examples
* RPM is built in every pipeline run, and is kept in GitLab for one week
* On a Git tag, RPM is published to Artifactory (f5-automation-toolchain-generic/f5-declarative-onboarding)

## Release Notes
* Release notes are tracked during development in `CHANGELOG.md`

## Process for release candidates
* Determine `<version>` by looking in `package.json`. `<version>` is the full version without the the `-#`.
* If we already have a release branch:
  * `git checkout <version>`
* If we don't already have a release branch:
  * `git checkout develop`
* `git pull`
* `mkdir -p src/schema/<version>`
* `cp src/schema/latest/* src/schema/<version>`
* git add and commit
* `git push origin`
* Go to the DO schedule in the `atg-build` project.
  * Ping the Teams "AS3-DO General" channel to not push anything to the develop/release branch, until after pipeline is complete. Additionally, please provide a link to the pipeline as an edit or follow up comment, for other's convenience.
  * Make sure the schedule's `gitBranch` CI/CD variable is set to the develop/release branch. NOTE: Do NOT change the variable back until after the pipeline completes
  * Run the schedule. This will:
    * Update and commit the build number in `package.json` and `package-lock.json` and commit those changes.
    * Tag the appropriate branch with the updated version (e.g. v1.34.0-4). The tag will kick off a DO pipeline with integration tests.
* If the DO pipeline is successful, that pipeline will upload the build artifacts to Artifactory and send the release email to the `f5-declarative-onboarding` distribution list.

## Process for release
### Begin process release at the very beginning of the first sprint of a new release, by performing the following actions:
* Follow the instructions for setting up a release candidate (see [Process for release candidates](#Process-for-release-candidates)).
* Create a new release branch using the major version, minor version, and patch number as the name (e.g. 1.34.0)
  * Build a release branch directly off of the tag generated by `atg-build` in the previous step.
  * It is also recommended to create the branch using the GUI to avoid any issues with an out-of-date local repository.
* Prepare the `develop` branch for the next development cycle by bumping the minor version
  * `git checkout develop`
  * `git pull`
  * Create and checkout a branch off of `develop` (e.g. `git checkout -b bump-to-v1.35.0`).
  * Edit package.json and package-lock.json to update the minor release number to the next version and reset the build number to 0. For example if you just created release branch 1.34.0, update to 1.35.0-0.
  * Add the next version (without the build number) to the `schemaVersion` array in `base.schema.json`.
  * Adding a new block to `CHANGELOG.md`.
  * Update the `info.version` property in `src/schema/latest/openapi.yaml` to the new DO version (e.g. 1.35.0).
  * git add, commit, and push
  * Submit an MR for these changes and wait for approval.

### Perform actions after go ahead from Go/No-Go meeting:
* Using the GUI, create 2 MRs.
  * One MR to merge the release branch to `master`.
  * One MR to merge the release branch to `develop`.
  * Do not squash commits.
  * You can self-approve and merge these MRs.
  * Note: If the GUI suggests a rebase, do a merge locally instead. DO NOT TRUST the GUI rebase tool.
    * Make sure that the version numbers in `package.json`, `package-lock.json`, `CHANGELOG.md`, etc... is correct. Rebase can sometimes rebase `develop` into the release branch.
    * Even though the MR was created via the GUI, pushing a local should be reflected in the MR
* Using the GUI, create a tag on the `master` branch in the format `v<version>` (e.g. `v1.34.0`).

## Documentation Release process
* After the third sprint is finished and the release branch has been created, checkout out the dev release branch and then merge it into **doc-release-branch**.
* Make any additions or modifications to the **doc-release-branch** for items specific to the release.
  * Update the release version in the **conf.py** file.
  * Update the latest version in the **versions.json** files (in doc-release branch and any LTS doc branches (for example **docs-3.36.1**, and **doc-3.32.1**)). Do NOT push the versions.json file for the LTS branches until the release has gone out.
  * Update the support.md file if applicable (currently not applicable for AS3, but is applicable for DO)
  * Make sure the **revision-history.rst** file is up-to-date with all work done and the Issues resolved from the changelog.md file.
* On release day, wait for the announcement that the code has been pushed to Github.
* Checkout out **docs-latest**, and then merge the **doc-release-branch** into docs-latest.
* Push **docs-latest** which starts the publishing process to clouddocs.f5.com.
* Checkout each of the LTS doc branches and push the changes to the **versions.json** files.
* Merge **docs-latest** back into **develop**.
